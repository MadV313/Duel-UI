<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ CCG Duel Field</title>
  <link rel="stylesheet" href="styles/style.css" />

  <!-- ‚úÖ Make API_BASE available to every script (before modules) -->
  <script>
    // Prefer the UI proxy (/api). Allow ?api=... override for local/dev.
    window.API_BASE = new URLSearchParams(location.search).get('api') || '/api';
    console.log('[UI] API_BASE =', window.API_BASE);
  </script>

  <!-- Duel Loader (for Discord-initiated PvP matches) -->
  <script type="module" src="scripts/duelLoader.js" defer></script>

  <!-- Script Modules (these now see window.API_BASE) -->
  <script type="module" src="/scripts/api-base.js"></script>
  <script type="module" src="/scripts/fetch-shim.js"></script>
  <script type="module" src="scripts/config.js" defer></script>
  <script type="module" src="scripts/duelState.js" defer></script>
  <script type="module" src="scripts/renderCard.js" defer></script>
  <script type="module" src="scripts/renderHand.js" defer></script>
  <script type="module" src="scripts/renderField.js" defer></script>
  <script type="module" src="scripts/renderDuelUI.js" defer></script>
  <script type="module" src="scripts/animations.js" defer></script>
  <script type="module" src="scripts/coinFlip.js" defer></script>
  <script type="module" src="scripts/duel.js" defer></script>
  <script type="module" src="scripts/buffTracker.js" defer></script>
  <script type="module" src="scripts/spectatorView.js" defer></script>

  <!-- Spectator Styles -->
  <link rel="stylesheet" href="styles/spectatorStyles.css" id="spectatorStyles" />
</head>

<body>
  <!-- ‚ùÑÔ∏è Snowfall overlay -->
  <div class="snowfall"></div>

  <!-- Player 2 (Opponent) -->
  <div id="player2-hand" class="hand"></div>
  <div id="player2-field" class="field"></div>

  <!-- HP & Turn Info -->
  <div id="hp-display">
    <div>Challenger HP: <span id="player1-hp">200</span></div>
    <div>Opponent HP: <span id="player2-hp">200</span></div>
  </div>
  <!-- üëá hidden until the coin flip completes -->
  <div id="turn-display" class="hidden"></div>

  <!-- Player 1 (You) -->
  <div id="player1-field" class="field"></div>
  <div id="player1-hand" class="hand"></div>

  <!-- Controls -->
  <div id="controls" style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 20px;">
    <button id="startPracticeBtn">üéÆ Start Practice Duel</button>
    <button id="drawBtn" onclick="drawCard()">Draw</button>
    <button id="endTurnBtn" onclick="endTurn()">End Turn</button>
    <!-- <button onclick="flipCoin()">Flip Coin</button> -->
  </div>

  <!-- Overlay for announcements -->
  <div id="announcement" class="overlay hidden" aria-live="polite"></div>

  <!-- Coin Flip Animation (centered & layered via CSS) -->
  <div id="coinFlipContainer">
    <div class="coin-flip-container">
      <img class="coin-flip-image" src="images/effects/coin_flip.gif" alt="Coin Flip" />
      <div class="coin-flip-result" aria-hidden="true"></div>
    </div>
  </div>

  <a href="https://madv313.github.io/HUB-UI/" class="return-to-hub">‚Üê Return to Hub</a>

  <!-- Inline Script Bindings -->
  <script type="module">
    import { loadPracticeDuel } from './scripts/loadPracticeDuel.js';
    import { renderSpectatorView } from './scripts/spectatorView.js';
    import { drawCard, endTurn } from './scripts/duel.js';

    // Expose bits used by inline onclicks / other scripts
    window.loadPracticeDuel = loadPracticeDuel;
    window.drawCard         = drawCard;
    window.endTurn          = endTurn;

    function $(id){ return document.getElementById(id); }
    function hide(el){ if(el) el.style.display='none'; }
    function show(el,disp){ if(el) el.style.display=disp; }

    function hideUntilFlip() {
      const hands  = ['player1-hand','player2-hand'];
      const fields = ['player1-field','player2-field'];
      hands.forEach(id => hide($(id)));
      fields.forEach(id => hide($(id)));
      hide($('drawBtn'));
      hide($('endTurnBtn'));

      // keep the banner hidden via class only (coinFlip will remove it)
      const turn = $('turn-display');
      if (turn) { turn.classList.add('hidden'); }
    }

    function init() {
      const urlParams   = new URLSearchParams(window.location.search);
      const isSpectator = urlParams.get('spectator') === 'true';
      const isMock      = urlParams.get('mock') === 'true';

      if (isSpectator) {
        renderSpectatorView();
        const controls = $('controls');
        if (controls) controls.style.display = 'none';
        const spec = $('spectatorStyles');
        if (spec) spec.disabled = false;
      } else {
        const spec = $('spectatorStyles');
        if (spec) spec.disabled = true;
      }

      // Only the Start button should be visible before coin flip (unless mock mode)
      if (!isSpectator && !isMock) hideUntilFlip();

      if (isMock) {
        $('controls').style.display = 'flex';
        show($('player1-hand'),'flex');
        show($('player2-hand'),'flex');
        show($('player1-field'),'flex');
        show($('player2-field'),'flex');
      }

      const startBtn = $('startPracticeBtn');
      if (startBtn) {
        startBtn.addEventListener('click', async () => {
          try {
            console.log('üéÆ Starting practice duel...');
            startBtn.disabled = true;
            startBtn.textContent = 'Initializing...';

            // ‚ö†Ô∏è Important: loadPracticeDuel() already performs the coin flip
            // and reveals the zones/buttons. Do NOT call flipCoin again here.
            await loadPracticeDuel();

            startBtn.textContent = '‚úÖ Practice Ready';
            startBtn.style.display = 'none'; // hide the button after start
          } catch (e) {
            console.error('‚ùå Start failed:', e);
            startBtn.disabled = false;
            startBtn.textContent = 'üéÆ Start Practice Duel';
          }
        });
      }

      console.log('[UI] Using API via', window.API_BASE);
    }

    // Fix for module/DOMContentLoaded race:
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  </script>
</body>
</html>
