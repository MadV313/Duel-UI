<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ CCG Duel Field</title>
  <link rel="stylesheet" href="styles/style.css" />

  <!-- ‚úÖ Make API_BASE available to every script (before modules) -->
  <script>
    // Prefer the UI proxy (/api). Allow ?api=... override for local/dev.
    window.API_BASE = new URLSearchParams(location.search).get('api') || '/api';
    console.log('[UI] API_BASE =', window.API_BASE);
  </script>

  <!-- Duel Loader (for Discord-initiated PvP matches) -->
  <script type="module" src="scripts/duelLoader.js" defer></script>

  <!-- Script Modules (these now see window.API_BASE) -->
  <script type="module" src="/scripts/api-base.js"></script>
  <script type="module" src="/scripts/fetch-shim.js"></script>
  <script type="module" src="scripts/config.js" defer></script>
  <script type="module" src="scripts/duelState.js" defer></script>
  <script type="module" src="scripts/renderCard.js" defer></script>
  <script type="module" src="scripts/renderHand.js" defer></script>
  <script type="module" src="scripts/renderField.js" defer></script>
  <script type="module" src="scripts/renderDuelUI.js" defer></script>
  <script type="module" src="scripts/animations.js" defer></script>
  <script type="module" src="scripts/coinFlip.js" defer></script>
  <script type="module" src="scripts/duel.js" defer></script>
  <script type="module" src="scripts/buffTracker.js" defer></script>
  <script type="module" src="scripts/spectatorView.js" defer></script>

  <!-- Spectator Styles -->
  <link rel="stylesheet" href="styles/spectatorStyles.css" id="spectatorStyles" />
</head>

<body>
  <!-- ‚ùÑÔ∏è Snowfall overlay -->
  <div class="snowfall"></div>

  <!-- Player 2 (Opponent) -->
  <div id="player2-hand" class="hand"></div>
  <div id="player2-field" class="field"></div>

  <!-- HP & Turn Info -->
  <div id="hp-display">
    <div>Challenger HP: <span id="player1-hp">200</span></div>
    <div>Opponent HP: <span id="player2-hp">200</span></div>
  </div>
  <!-- üëá hidden until coin flip completes -->
  <div id="turn-display" class="hidden"></div>

  <!-- Player 1 (You) -->
  <div id="player1-field" class="field"></div>
  <div id="player1-hand" class="hand"></div>

  <!-- Controls -->
  <div id="controls" style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 20px;">
    <button id="startPracticeBtn">üéÆ Start Practice Duel</button>
    <button id="drawBtn" onclick="drawCard()">Draw</button>
    <button id="endTurnBtn" onclick="endTurn()">End Turn</button>
    <!-- <button onclick="flipCoin()">Flip Coin</button> -->
  </div>

  <!-- Overlay for announcements -->
  <div id="announcement" class="overlay hidden"></div>

  <!-- Coin Flip Animation -->
  <div id="coinFlipContainer" style="display:none; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
    <img src="images/coinflip.gif" alt="Coin Flip" style="width: 120px; height: 120px;" />
  </div>

  <a href="https://madv313.github.io/HUB-UI/" class="return-to-hub">‚Üê Return to Hub</a>

  <!-- Inline Script Bindings -->
  <script type="module">
    import { loadPracticeDuel } from './scripts/loadPracticeDuel.js';
    import { duelState } from './scripts/duelState.js';
    import { flipCoin } from './scripts/coinFlip.js';
    import { renderDuelUI } from './scripts/renderDuelUI.js';
    import { renderSpectatorView } from './scripts/spectatorView.js';
    import { drawCard, endTurn } from './scripts/duel.js';

    // Expose bits used by inline onclicks / other scripts
    window.flipCoin         = flipCoin;
    window.loadPracticeDuel = loadPracticeDuel;
    window.drawCard         = drawCard;
    window.endTurn          = endTurn;

    function showAfterFlip() {
      const hands  = ['player1-hand','player2-hand'];
      const fields = ['player1-field','player2-field'];
      hands.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'flex'; });
      fields.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'grid'; });
      const draw = document.getElementById('drawBtn');
      const endT = document.getElementById('endTurnBtn');
      if (draw) draw.style.display = 'inline-block';
      if (endT) endT.style.display = 'inline-block';
    }

    function hideUntilFlip() {
      const hands  = ['player1-hand','player2-hand'];
      const fields = ['player1-field','player2-field'];
      hands.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
      fields.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
      const draw = document.getElementById('drawBtn');
      const endT = document.getElementById('endTurnBtn');
      if (draw) draw.style.display = 'none';
      if (endT) endT.style.display = 'none';
      // keep the banner hidden until flip
      const turn = document.getElementById('turn-display');
      if (turn) turn.classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams   = new URLSearchParams(window.location.search);
      const isSpectator = urlParams.get('spectator') === 'true';
      const isMock      = urlParams.get('mock') === 'true';

      if (isSpectator) {
        renderSpectatorView();
        document.getElementById('controls').style.display = 'none';
        document.getElementById('spectatorStyles').disabled = false;
      } else {
        document.getElementById('spectatorStyles').disabled = true;
      }

      // Only the Start button should be visible before coin flip (unless mock mode)
      if (!isSpectator && !isMock) hideUntilFlip();

      if (isMock) {
        document.getElementById('controls').style.display = 'flex';
        document.getElementById('player1-hand').style.display = 'flex';
        document.getElementById('player2-hand').style.display = 'flex';
        document.getElementById('player1-field').style.display = 'flex';
        document.getElementById('player2-field').style.display = 'flex';
      }

      const startBtn = document.getElementById('startPracticeBtn');
      if (startBtn) {
        startBtn.addEventListener('click', async () => {
          try {
            console.log('üéÆ Starting practice duel...');
            startBtn.disabled = true;
            startBtn.textContent = 'Initializing...';

            // Init practice duel (does NOT reveal UI yet)
            await loadPracticeDuel();

            // Flip coin (reveals the turn banner)
            startBtn.textContent = 'Flipping coin...';
            await flipCoin(duelState.currentPlayer);

            // Reveal zones and render with fetched state
            showAfterFlip();
            renderDuelUI();

            startBtn.textContent = '‚úÖ Practice Ready';
            startBtn.style.display = 'none'; // hide the button after start
          } catch (e) {
            console.error('‚ùå Start failed:', e);
            startBtn.disabled = false;
            startBtn.textContent = 'üéÆ Start Practice Duel';
          }
        });
      }

      console.log('[UI] Using API via', window.API_BASE);
    });
  </script>
</body>
</html>
