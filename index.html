<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ CCG Duel Field</title>
  <link rel="stylesheet" href="styles/style.css" />

  <!-- Small safety styles so overlays never block the sound toggle, and labels look tidy -->
  <style>
    .snowfall { pointer-events: none; }
    #sound-toggle { pointer-events: auto; z-index: 10001; }
    .zone-label {
      text-align: center;
      font: 600 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell;
      color: #c9d4df;
      opacity: .85;
      margin: 6px 0 2px;
      user-select: none;
    }
  </style>

  <!-- ‚úÖ Global bootstrap: expose token/api/mode/imgbase to all scripts -->
  <script>
    (function () {
      const qs = new URLSearchParams(location.search);

      // Prefer the UI proxy (/api). Allow ?api=... override for local/dev.
      const API = (qs.get('api') || '/api').replace(/\/+$/, '');
      const TOKEN = qs.get('token') || '';
      const MODE = (qs.get('mode') || '').toLowerCase();
      const IMG_BASE = (qs.get('imgbase') || '').replace(/\/+$/, '');

      // Export to window for all ES modules / inline handlers
      window.API_BASE = API;
      window.USER_TOKEN = TOKEN;
      window.DUEL_MODE = MODE;
      window.IMG_BASE = IMG_BASE;

      console.log('[UI] API_BASE =', API, 'TOKEN set?', !!TOKEN, 'MODE =', MODE, 'IMG_BASE =', IMG_BASE || '(default in renderers)');
    })();
  </script>

  <!-- Duel Loader (for Discord-initiated PvP matches) -->
  <script type="module" src="scripts/duelLoader.js" defer></script>

  <!-- Script Modules (these now see window.API_BASE, window.USER_TOKEN, window.IMG_BASE) -->
  <script type="module" src="/scripts/api-base.js"></script>
  <script type="module" src="/scripts/fetch-shim.js"></script>
  <script type="module" src="scripts/config.js" defer></script>
  <script type="module" src="scripts/duelState.js" defer></script>
  <script type="module" src="scripts/renderCard.js" defer></script>
  <script type="module" src="scripts/renderHand.js" defer></script>
  <script type="module" src="scripts/renderField.js" defer></script>
  <script type="module" src="scripts/renderDuelUI.js" defer></script>
  <script type="module" src="scripts/animations.js" defer></script>
  <script type="module" src="scripts/coinFlip.js" defer></script>
  <script type="module" src="scripts/duel.js" defer></script>
  <script type="module" src="scripts/buffTracker.js" defer></script>

  <!-- Spectator Styles -->
  <link rel="stylesheet" href="styles/spectatorStyles.css" id="spectatorStyles" />
</head>

<body>
  <!-- ‚ùÑÔ∏è Snowfall overlay -->
  <div class="snowfall"></div>

  <!-- Labels + Player 2 (Opponent) -->
  <div class="zone-label" id="label-player2-hand">Opponent Hand</div>
  <div id="player2-hand" class="hand hand--top"></div>

  <div class="zone-label" id="label-player2-field">Opponent Field</div>
  <div id="player2-field" class="field"></div>

  <!-- HP & Turn Info -->
  <div id="hp-display">
    <div>Challenger HP: <span id="player1-hp">200</span></div>
    <div>Opponent HP: <span id="player2-hp">200</span></div>
  </div>
  <!-- üëá hidden until the coin flip completes -->
  <div id="turn-display" class="hidden"></div>

  <!-- Labels + Player 1 (You) -->
  <div class="zone-label" id="label-player1-field">Your Field</div>
  <div id="player1-field" class="field"></div>

  <div class="zone-label" id="label-player1-hand">Your Hand</div>
  <div id="player1-hand" class="hand hand--bottom"></div>

  <!-- Controls -->
  <div id="controls" style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 20px;">
    <button id="startPracticeBtn">üéÆ Start Practice Duel</button>
    <button id="drawBtn" onclick="drawCard()">Draw</button>
    <button id="endTurnBtn" onclick="endTurn()">End Turn</button>
    <!-- <button onclick="flipCoin()">Flip Coin</button> -->
  </div>

  <!-- Overlay for announcements -->
  <div id="announcement" class="overlay hidden" aria-live="polite"></div>

  <!-- Coin Flip Animation (centered & layered via CSS) -->
  <div id="coinFlipContainer">
    <div class="coin-flip-container">
      <img class="coin-flip-image" src="images/effects/coin_flip.gif" alt="Coin Flip" />
      <div class="coin-flip-result" aria-hidden="true"></div>
    </div>
  </div>

  <!-- üîí Anchored discard counters (don‚Äôt drift with hand width) -->
  <div class="discard-anchor discard-anchor--top">
    <div id="player2-discard-counter" class="discard-counter">Discard: 0</div>
  </div>
  <div class="discard-anchor discard-anchor--bottom">
    <div id="player1-discard-counter" class="discard-counter">Discard: 0</div>
  </div>

  <a href="https://madv313.github.io/HUB-UI/" class="return-to-hub" id="returnToHub">‚Üê Return to Hub</a>

  <!-- Inline Script Bindings -->
  <script type="module">
    import { loadPracticeDuel } from './scripts/loadPracticeDuel.js';
    import { renderSpectatorView } from './scripts/spectatorView.js';
    import { drawCard, endTurn } from './scripts/duel.js';

    // Expose bits used by inline onclicks / other scripts
    window.loadPracticeDuel = loadPracticeDuel;
    window.drawCard         = drawCard;
    window.endTurn          = endTurn;

    function $(id){ return document.getElementById(id); }
    function hide(el){ if(el) el.style.display='none'; }
    function show(el,disp){ if(el) el.style.display=disp; }

    function hideUntilFlip() {
      const hands  = ['player1-hand','player2-hand'];
      const fields = ['player1-field','player2-field'];
      hands.forEach(id => hide($(id)));
      fields.forEach(id => hide($(id)));
      hide($('drawBtn'));
      hide($('endTurnBtn'));

      // keep the banner hidden via class only (coinFlip will remove it)
      const turn = $('turn-display');
      if (turn) { turn.classList.add('hidden'); }
    }

    function rewriteReturnToHub() {
      const a = $('returnToHub');
      if (!a) return;

      try {
        const u = new URL(a.href);
        if (window.USER_TOKEN) u.searchParams.set('token', window.USER_TOKEN);
        if (window.API_BASE)   u.searchParams.set('api', window.API_BASE);
        if (window.IMG_BASE)   u.searchParams.set('imgbase', window.IMG_BASE);
        a.href = u.toString();
      } catch {
        // Fallback if relative href is ever used
        let base = a.getAttribute('href') || 'https://madv313.github.io/HUB-UI/';
        const parts = [];
        if (window.USER_TOKEN) parts.push(`token=${encodeURIComponent(window.USER_TOKEN)}`);
        if (window.API_BASE)   parts.push(`api=${encodeURIComponent(window.API_BASE)}`);
        if (window.IMG_BASE)   parts.push(`imgbase=${encodeURIComponent(window.IMG_BASE)}`);
        const sep = base.includes('?') ? '&' : '?';
        if (parts.length) a.setAttribute('href', `${base}${sep}${parts.join('&')}`);
      }
    }

    function init() {
      const urlParams   = new URLSearchParams(window.location.search);
      const isSpectator = urlParams.get('spectator') === 'true';
      const isMock      = urlParams.get('mock') === 'true';

      rewriteReturnToHub();

      if (isSpectator) {
        renderSpectatorView();
        const controls = $('controls');
        if (controls) controls.style.display = 'none';
        const spec = $('spectatorStyles');
        if (spec) spec.disabled = false;
      } else {
        const spec = $('spectatorStyles');
        if (spec) spec.disabled = true;
      }

      // Only the Start button should be visible before coin flip (unless mock mode)
      if (!isSpectator && !isMock) hideUntilFlip();

      if (isMock) {
        $('controls').style.display = 'flex';
        show($('player1-hand'),'flex');
        show($('player2-hand'),'flex');
        show($('player1-field'),'flex');
        show($('player2-field'),'flex');
      }

      const startBtn = $('startPracticeBtn');
      if (startBtn) {
        startBtn.addEventListener('click', async () => {
          try {
            console.log('üéÆ Starting practice duel...');
            startBtn.disabled = true;
            startBtn.textContent = 'Initializing...';

            // ‚ö†Ô∏è loadPracticeDuel() already performs the coin flip & reveals UI
            await loadPracticeDuel();

            startBtn.textContent = '‚úÖ Practice Ready';
            startBtn.style.display = 'none';
          } catch (e) {
            console.error('‚ùå Start failed:', e);
            startBtn.disabled = false;
            startBtn.textContent = 'üéÆ Start Practice Duel';
          }
        });
      }

      console.log('[UI] Using API via', window.API_BASE);
    }

    // Fix for module/DOMContentLoaded race:
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  </script>
</body>
</html>
